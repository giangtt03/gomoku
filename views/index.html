<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomoku Realtime</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #eaeaea;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(15, 40px);
            grid-gap: 2px;
            margin-top: 20px;
        }

        .cell {
            width: 40px;
            height: 40px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            border: 1px solid #cccccc;
            /* Thêm viền cho ô */
        }

        #status {
            margin-bottom: 10px;
            font-size: 20px;
        }

        #reset-confirmation {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 1000;
        }

        button {
            margin: 5px;
            padding: 10px 20px;
        }

        p {
            color: #333333;
            /* Màu chữ cho thẻ <p> */
            font-size: 16px;
            /* Kích thước chữ cho thẻ <p> */
            line-height: 1.5;
            /* Khoảng cách giữa các dòng */
            max-width: 800px;
            /* Giới hạn chiều rộng của thẻ <p> */
            text-align: center;
            /* Căn giữa nội dung */
            margin: 20px;
            /* Thêm khoảng cách trên và dưới cho thẻ <p> */
            /* background-color: #ffffff; */
            /* Nền trắng cho dễ đọc */
            padding: 15px;
            /* Thêm padding cho thẻ <p> */
            border-radius: 8px;
            /* Bo tròn các góc */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            /* Thêm bóng nhẹ cho thẻ <p> */
        }
    </style>
</head>

<body>
    <h1>Gomoku Realtime</h1>
    <div id="status">Waiting for another player...</div>
    <div id="board"></div>

    <div id="reset-confirmation">
        <p id="winner-message"></p>
        <button id="yes-play-again">Yes</button>
        <button id="no-play-again">No</button>
    </div>

    <div>
        <p>Gomoku, also known as Five in a Row, is an abstract strategy board game that can be played on paper as once placed, pieces are not moved. The term Gomoku originates from Japanese (gomokunarabe), where "go" means five, "moku" refers to pieces, and "narabe" means line-up. Learn more on the <span id="wikipedia-link" style="color:blue; text-decoration:underline; cursor:pointer;">Wikipedia Gomoku</span> page.</p>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const board = document.getElementById('board');
        const statusDiv = document.getElementById('status');
        const resetConfirmation = document.getElementById('reset-confirmation');
        const winnerMessage = document.getElementById('winner-message');
        let playerNumber = null;
        let gameStarted = false;
        let currentTurn = 1; // Lượt đầu tiên là của Player 1
        let resetVotes = {};
        let otherPlayerId = null; // Biến lưu ID của người chơi khác
        let bothPlayersAgreed = false; // Biến theo dõi trạng thái rétart

        document.getElementById('wikipedia-link').addEventListener('click', function () {
            window.open('https://en.wikipedia.org/wiki/Gomoku', '_blank'); 
        });

        const createBoard = () => {
            board.innerHTML = ''; // Xóa bàn cờ cũ
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.innerText = '';
                    board.appendChild(cell);

                    cell.addEventListener('click', () => {
                        if (!cell.innerText && playerNumber && gameStarted && currentTurn === playerNumber) {
                            // Gửi thông tin nước đi
                            socket.emit('move', {
                                row: i,
                                col: j,
                                player: playerNumber
                            });
                        }
                    });
                }
            }
        };

        socket.on('player-assigned', (number) => {
            playerNumber = number;
            statusDiv.innerText = `You are player ${playerNumber}. Waiting for another player...`;
        });

        socket.on('game-start', (otherPlayer) => {
            gameStarted = true;
            currentTurn = 1;
            otherPlayerId = otherPlayer;
            statusDiv.innerText = `Game started! You are player ${playerNumber}.`;
        });

        socket.on('move', (data) => {
            const { row, col, player } = data;
            const cell = board.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            cell.innerText = player === 1 ? 'X' : 'O'; // Cập nhật ô với X hoặc O
            currentTurn = player === 1 ? 2 : 1; // Cập nhật lượt chơi
            statusDiv.innerText = `Player ${currentTurn === playerNumber ? 'you' : currentTurn}'s turn.`; // Cập nhật thông báo
        });

        socket.on('turn-changed', (newTurn) => {
            currentTurn = newTurn; // Cập nhật lượt đi mới
            statusDiv.innerText = `Player ${currentTurn === playerNumber ? 'you' : currentTurn}'s turn.`; // Cập nhật thông báo
        });

        socket.on('win', (player) => {
            gameStarted = false;
            winnerMessage.innerText = `Player ${player} wins! Do you want to play again?`;
            resetConfirmation.style.display = 'block'; // Hiện thông báo chơi lại
        });

        // Xử lý nút "Yes" để chơi lại
        document.getElementById('yes-play-again').addEventListener('click', () => {
            console.log('Yes clicked');
            resetVotes[playerNumber] = true;
            if (resetVotes[playerNumber] && resetVotes[otherPlayerId]) {
                bothPlayersAgreed = true;
                socket.emit('reset-request', playerNumber);
            } else {
                socket.emit('reset-request', playerNumber);
            }
        });

        // socket.on('reset-confirmation', (playerId) => {
        //     resetVotes[playerId] = true; // Đánh dấu người chơi đã đồng ý
        //     console.log(`Player ${playerId} agreed to reset. Current resetVotes: `, resetVotes);

        //     // Kiểm tra nếu cả 2 ID người chơi đã đồng ý reset
        //     if (Object.keys(resetVotes).length === 2) {
        //         console.log('Both players agreed to reset. Sending reset-accepted.');
        //         socket.emit('reset-accepted'); // Gửi reset-accepted khi cả hai đã đồng ý
        //     }
        // });

        socket.on('reset-confirmation', (playerId) => {
            resetVotes[playerId] = true;
            console.log(`Player ${playerId} agreed to reset. Current resetVotes: `, resetVotes);

            // Kiểm tra xem cả hai người chơi đã đồng ý hay chưa
            if (Object.keys(resetVotes).length === 2) {
                console.log('Both players agreed to reset. Sending reset-accepted.');
                socket.emit('reset-accepted'); // Gửi reset-accepted khi cả hai đã đồng ý
            }
        });


        // Xử lý nút "No" để không chơi lại
        document.getElementById('no-play-again').addEventListener('click', () => {
            console.log('No clicked');
            resetConfirmation.style.display = 'none'; // Ẩn thông báo
            resetVotes = {};
        });

        // Reset lại trạng thái khi trò chơi được khởi động lại
        socket.on('reset', () => {
            console.log('Received reset event from server.');
            resetVotes = {};
            createBoard(); // Tạo bàn cờ mới
            gameStarted = true;
            currentTurn = 1; // Reset lại lượt đầu tiên là Player 1
            statusDiv.innerText = `Game restarted. You are player ${playerNumber}.`;
            resetConfirmation.style.display = 'none'; // Ẩn thông báo
        });

        createBoard();
    </script>
</body>

</html>