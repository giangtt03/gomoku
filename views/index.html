<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gomoku Realtime</title>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.2.4/lib/index.js"></script> 
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #322f2f; 
            color: white; 
            font-family: Arial, sans-serif;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(19, 40px); 
            grid-gap: 2px;
            margin-top: 20px;
        }

        .cell {
            width: 40px;
            height: 40px;
            background-color: #444444; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            border: 1px solid #888888;
            border-radius: 4px; 
        }

        #status {
            margin-bottom: 10px;
            font-size: 20px;
        }

        #reset-confirmation {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 1000;
        }

        button {
            margin: 5px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        p {
            color: #dddddd; 
            font-size: 16px;
            line-height: 1.5;
            max-width: 800px;
            text-align: center;
            margin: 20px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .highlight {
            background-color: #e7e7f9;
        }
    </style>
</head>

<body>
    <h1 class="text-4xl font-bold">Gomoku Realtime</h1>
    <div id="status" class="mt-5">Waiting for another player...</div>
    <div id="board"></div>
    <div id="reset-confirmation">
        <p id="winner-message"></p>
        <p>Time remaining: <span id="countdown-timer">10</span>s</p>
        <button id="yes-play-again">Yes</button>
        <button id="no-play-again">No</button>
    </div>
    <div>
        <p>Gomoku, also known as Five in a Row, is an abstract strategy board game that can be played on paper as once
            placed, pieces are not moved. The term Gomoku originates from Japanese (gomokunarabe), where "go" means
            five, "moku" refers to pieces, and "narabe" means line-up. Learn more on the <span id="wikipedia-link"
                style="color:rgb(73, 73, 140); text-decoration:underline; cursor:pointer;">Wikipedia Gomoku</span> page.</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const board = document.getElementById('board');
        const statusDiv = document.getElementById('status');
        const resetConfirmation = document.getElementById('reset-confirmation');
        const winnerMessage = document.getElementById('winner-message');
        let playerNumber = null;
        let gameStarted = false;
        let currentTurn = 1;
        let resetVotes = {};
        let otherPlayerId = null;
        let bothPlayersAgreed = false;
        let countdownInterval;
        let lastMoveCell = null;
        const urlParams = new URLSearchParams(window.location.search);
        const guestId = urlParams.get('guestId');

        const fetchGuestData = async () => {
            try {
                const response = await fetch(`/go/guest/${guestId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch guest data');
                }

                const contentType = response.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.guest) {
                        displayGuestInfo(data.guest);
                    }
                } else {
                    throw new Error('Response is not JSON');
                }
            } catch (error) {
                console.error('Error fetching guest data:', error);
            }
        };

        const displayGuestInfo = (guest) => {
            statusDiv.innerHTML = `
                <div>
                    <img src="${guest.avatar}" alt="Guest Avatar" style="width: 50px; height: 50px; border-radius: 50%;">
                    <p>${guest.guestName}</p>
                </div>
            `;
        };

        if (guestId) {
            fetchGuestData(guestId);
        } else {
            console.error("Guest ID is missing in the URL.");
        }

        document.getElementById('wikipedia-link').addEventListener('click', function () {
            window.open('https://en.wikipedia.org/wiki/Gomoku', '_blank');
        });

        const createBoard = () => {
            board.innerHTML = '';
            for (let i = 0; i < 19; i++) { 
                for (let j = 0; j < 19; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.innerText = '';
                    board.appendChild(cell);

                    cell.addEventListener('click', () => {
                        if (!cell.innerText && playerNumber && gameStarted && currentTurn === playerNumber) {
                            socket.emit('move', {
                                row: i,
                                col: j,
                                player: playerNumber
                            });
                        }
                    });
                }
            }
        };

        socket.on('player-assigned', (number) => {
            playerNumber = number;
            statusDiv.innerText = `You are player ${playerNumber}. Waiting for another player...`;
            fetchGuestData();
        });

        socket.on('game-start', (otherPlayer) => {
            gameStarted = true;
            currentTurn = 1;
            otherPlayerId = otherPlayer;
            statusDiv.innerText = `Game started! You are player ${playerNumber}.`;
        });

        socket.on('move', (data) => {
            const { row, col, player } = data;
            const cell = board.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            cell.innerText = player === 1 ? 'X' : 'O';

            if (lastMoveCell) {
                lastMoveCell.classList.remove('highlight');
            }

            cell.classList.add('highlight');
            lastMoveCell = cell;
            currentTurn = player === 1 ? 2 : 1;
            statusDiv.innerText = `Player ${currentTurn === playerNumber ? 'you' : currentTurn}'s turn.`;
        });

        socket.on('turn-changed', (newTurn) => {
            currentTurn = newTurn;
            statusDiv.innerText = `Player ${currentTurn === playerNumber ? 'you' : currentTurn}'s turn.`;
        });

        socket.on('win', (player) => {
            gameStarted = false;
            winnerMessage.innerText = `Player ${player} wins! Do you want to play again?`;
            resetConfirmation.style.display = 'block';
            startCountdown();
        });

        function startCountdown() {
            let countdown = 10;
            document.getElementById('countdown-timer').innerText = countdown;

            clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown-timer').innerText = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('no-play-again').click();
                }
            }, 1000);
        }

        document.getElementById('yes-play-again').addEventListener('click', () => {
            console.log('Yes clicked');
            resetVotes[playerNumber] = true;
            clearInterval(countdownInterval);
            if (resetVotes[playerNumber] && resetVotes[otherPlayerId]) {
                bothPlayersAgreed = true;
                socket.emit('reset-request', playerNumber);
            } else {
                socket.emit('reset-request', playerNumber);
            }
        });

        document.getElementById('no-play-again').addEventListener('click', () => {
            resetConfirmation.style.display = 'none';
            socket.emit('game-reset', { restart: false });
            resetVotes = {};
        });

        createBoard();
    </script>
</body>

</html>
